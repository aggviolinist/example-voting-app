pipeline {
    agent none
    
    environment {
        DOCKER_BUILDKIT = '1'
        COMPOSE_DOCKER_CLI_BUILD = '1'
        DOCKER_REGISTRY = 'index.docker.io'
        DOCKER_REGISTRY_URL = 'https://index.docker.io/v1/'
        GIT_REPO_NAME = "example-voting-app"
        GIT_USER_NAME = "aggviolinist"
        GIT_BRANCH = "main"
    }

    stages {
        stage('Build Vote Image') {
            agent {
                docker {
                    image 'docker:25.0.3-cli'
                    args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            environment {
                DOCKER_IMAGE = "violinist999/vote:${BUILD_NUMBER}"  
            }
            steps {
                script {
                    echo "Building Vote service image..."
                    sh '''
                        echo "Cleaning up old Docker data..."
                        docker system prune -af --volumes || true
                        
                        echo "Building image ${DOCKER_IMAGE}"
                        docker build -t ${DOCKER_IMAGE} ./vote
                    '''
                }
            }
        }

        stage('Build Result Image') {
            agent {
                docker {
                    image 'docker:25.0.3-cli'
                    args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            environment {
                DOCKER_IMAGE = "violinist999/result:${BUILD_NUMBER}"  // Update username
            }
            steps {
                script {
                    echo "Building Result service image..."
                    sh '''
                        echo "Building image ${DOCKER_IMAGE}"
                        docker build -t ${DOCKER_IMAGE} ./result
                    '''
                }
            }
        }

        stage('Build Worker Image') {
            agent {
                docker {
                    image 'docker:25.0.3-cli'
                    args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            environment {
                DOCKER_IMAGE = "violinist999/worker:${BUILD_NUMBER}"  // Update username
            }
            steps {
                script {
                    echo "Building Result worker image..."
                    sh '''
                        echo "Building image ${DOCKER_IMAGE}"
                        docker build -t ${DOCKER_IMAGE} ./worker
                    '''
                }
            }
        }

        stage('Push Vote Image') {
            agent {
                docker {
                    image 'docker:25.0.3-cli'
                    args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            environment {
                DOCKER_IMAGE = "violinist999/vote:${BUILD_NUMBER}" 
            }
            steps {
                script {
                    echo "Pushing Vote image to Docker Hub..."
                    def dockerImage = docker.image("${DOCKER_IMAGE}")
                    docker.withRegistry("${DOCKER_REGISTRY_URL}", 'docker-creds') {
                        dockerImage.push()
                        dockerImage.push('latest')
                    }
                }
            }
        }

        stage('Push Result Image') {
            agent {
                docker {
                    image 'docker:25.0.3-cli'
                    args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            environment {
                DOCKER_IMAGE = "violinist999/result:${BUILD_NUMBER}"
            }
            steps {
                script {
                    echo "Pushing Result image to Docker Hub..."
                    def dockerImage = docker.image("${DOCKER_IMAGE}")
                    docker.withRegistry("${DOCKER_REGISTRY_URL}", 'docker-creds') {
                        dockerImage.push()
                        dockerImage.push('latest')
                    }
                }
            }
        }

        stage('Push Worker Image') {
            agent {
                docker {
                    image 'docker:25.0.3-cli'
                    args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            environment {
                DOCKER_IMAGE = "violinist999/worker:${BUILD_NUMBER}"
            }
            steps {
                script {
                    echo "Pushing Result image to Docker Hub..."
                    def dockerImage = docker.image("${DOCKER_IMAGE}")
                    docker.withRegistry("${DOCKER_REGISTRY_URL}", 'docker-creds') {
                        dockerImage.push()
                        dockerImage.push('latest')
                    }
                }
            }
        }


        stage('Approval for Deployment') {
            steps {
                script {
                    input message: 'Do you want to deploy to Kubernetes?', 
                          ok: 'Deploy',
                          submitter: 'admin'
                }
            }
        }

        stage('Update K8s Manifests') {
            agent {
                docker {
                    image 'ubuntu:latest'
                    args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                withCredentials([string(credentialsId: 'github-creds', variable: 'GITHUBTOKEN')]) {
                    sh '''
                        apt-get update -y
                        apt-get install -y git
                        
                        git config --global --add safe.directory ${WORKSPACE}
                        git clean -fd
                        git fetch origin             
                        git checkout main
                        git reset --hard origin/main
                        git pull origin main
                        
                        git config user.email "mulandimaei76@gmail.com" 
                        git config user.name "${GIT_USER_NAME}"
                        
                        # Update vote deployment
                        if [ -f kubernetes/voting-app-deploy.yaml ]; then
                            sed -i "s|image:.*vote:.*|image: violinist999/vote:${BUILD_NUMBER}|g" kubernetes/voting-app-deploy.yaml
                            git add kubernetes/voting-app-deploy.yaml
                        else
                            echo "WARNING: kubernetes/voting-app-deploy.yaml not found!"
                        fi
                        
                        # Update result deployment
                        if [ -f kubernetes/results-app-deploy.yaml ]; then
                            sed -i "s|image:.*result:.*|image: violinist999/result:${BUILD_NUMBER}|g" kubernetes/results-app-deploy.yaml
                            git add kubernetes/results-app-deploy.yaml
                        else
                            echo "WARNING: kubernetes/results-app-deploy.yaml not found!"
                        fi

                         # Update worker deployment
                        if [ -f kubernetes/worker-deploy.yaml ]; then
                            sed -i "s|image:.*result:.*|image: violinist999/worker:${BUILD_NUMBER}|g" kubernetes/worker-deploy.yaml
                            git add kubernetes/worker-deploy.yaml
                        else
                            echo "WARNING: kubernetes/worker-deploy.yaml not found!"
                        fi
                        
                        # Commit and push if there are changes
                        if git diff --cached --quiet; then
                            echo "No changes to commit"
                        else
                            git commit -m "Updated Docker images to build ${BUILD_NUMBER}"
                            git pull --rebase origin main
                            git push https://${GITHUBTOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:main
                        fi
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully! Images built and manifests updated."
        }
        failure {
            echo "Pipeline failed. Please check the logs."
        }
    }
}